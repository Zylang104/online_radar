<!DOCTYPE html>
<html>
<head>
    <title>Radar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        body {
            background: #0d0d0d;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        #container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        #radar {
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        #crossX {
            position: absolute;
            width: 100%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            top: 50%;
        }
        #crossY {
            position: absolute;
            height: 100%;
            width: 1px;
            background: rgba(255, 255, 255, 0.1);
            left: 50%;
        }
        #center {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #direction {
            position: absolute;
            width: 1px;
            height: 30px;
            background: rgba(255, 255, 255, 0.5);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
        }
        .dot {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            will-change: transform;
        }
        .name {
            position: absolute;
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            left: 50%;
            top: -14px;
            transform: translateX(-50%);
        }
        #info {
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }
        #controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #controls button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }
        #controls button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        #zoom {
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            min-width: 60px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="radar">
            <div id="crossX"></div>
            <div id="crossY"></div>
            <div id="direction"></div>
            <div id="center"></div>
        </div>
        <div id="controls">
            <button id="zoomOut">-</button>
            <div id="zoom">1x</div>
            <button id="zoomIn">+</button>
        </div>
        <div id="info">0 players</div>
    </div>
    <script>
        var radar = document.getElementById("radar");
        var info = document.getElementById("info");
        var zoomText = document.getElementById("zoom");
        var dots = {};
        var scale = 2;
        var latestData = [];
        var radarRadius = 200;

        document.getElementById("zoomIn").onclick = function() {
            scale = scale / 1.5;
            if (scale < 0.1) scale = 0.1;
            zoomText.innerText = (2 / scale).toFixed(1) + "x";
        };

        document.getElementById("zoomOut").onclick = function() {
            scale = scale * 1.5;
            if (scale > 20) scale = 20;
            zoomText.innerText = (2 / scale).toFixed(1) + "x";
        };

        radar.onwheel = function(e) {
            e.preventDefault();
            if (e.deltaY < 0) {
                scale = scale / 1.2;
                if (scale < 0.1) scale = 0.1;
            } else {
                scale = scale * 1.2;
                if (scale > 20) scale = 20;
            }
            zoomText.innerText = (2 / scale).toFixed(1) + "x";
        };

        function fetchData() {
            fetch("/players")
                .then(function(r) { return r.json(); })
                .then(function(players) {
                    latestData = players;
                });
        }

        function render() {
            var players = latestData;
            info.innerText = players.length + " player" + (players.length === 1 ? "" : "s");
            var names = [];
            for (var i = 0; i < players.length; i++) {
                var p = players[i];
                names.push(p.name);
                
                var dx = p.x / scale;
                var dz = p.z / scale;
                var distance = Math.sqrt(dx * dx + dz * dz);
                
                if (distance > radarRadius - 10) {
                    var ratio = (radarRadius - 10) / distance;
                    dx *= ratio;
                    dz *= ratio;
                }
                
                var x = 200 + dx;
                var y = 200 + dz;
                
                if (!dots[p.name]) {
                    var dot = document.createElement("div");
                    dot.className = "dot";
                    var nm = document.createElement("div");
                    nm.className = "name";
                    dot.appendChild(nm);
                    radar.appendChild(dot);
                    dots[p.name] = dot;
                }
                
                var color = p.r + "," + p.g + "," + p.b;
                dots[p.name].style.background = "rgb(" + color + ")";
                dots[p.name].style.boxShadow = "0 0 10px rgba(" + color + ", 0.5)";
                dots[p.name].style.transform = "translate(" + (x - 3) + "px, " + (y - 3) + "px)";
                dots[p.name].children[0].innerText = p.name;
            }
            for (var n in dots) {
                if (names.indexOf(n) === -1) {
                    dots[n].remove();
                    delete dots[n];
                }
            }
            requestAnimationFrame(render);
        }

        setInterval(fetchData, 20);
        requestAnimationFrame(render);
    </script>
</body>
</html>